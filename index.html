import React, { useState, useEffect } from "react";
import { initializeApp } from "firebase/app";
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  updateDoc,
  doc,
  arrayUnion,
} from "firebase/firestore";
import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL,
} from "firebase/storage";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
} from "firebase/auth";

// üî• Your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBs6PXDRMzvwnKi1FfR1ubJQozYgJeBCdc",
  authDomain: "topscrolling-f78b9.firebaseapp.com",
  projectId: "topscrolling-f78b9",
  storageBucket: "topscrolling-f78b9.firebasestorage.app",
  messagingSenderId: "246727427004",
  appId: "1:246727427004:web:2ad6ea7f6b2858739aa1b9",
  measurementId: "G-262DBFWGD0"
};

// üîß Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);
const auth = getAuth(app);

export default function App() {
  const [user, setUser] = useState(null);
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [caption, setCaption] = useState("");
  const [image, setImage] = useState(null);
  const [posts, setPosts] = useState([]);
  const [comment, setComment] = useState("");

  // üî• Get posts real-time
  useEffect(() => {
    const unsub = onSnapshot(collection(db, "posts"), (snapshot) => {
      setPosts(snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() })));
    });
    return unsub;
  }, []);

  // üîê Auth
  const signup = async () => {
    await createUserWithEmailAndPassword(auth, email, password);
    alert("Account created!");
  };

  const login = async () => {
    await signInWithEmailAndPassword(auth, email, password);
    setUser(auth.currentUser);
    alert("Logged in!");
  };

  const logout = async () => {
    await signOut(auth);
    setUser(null);
  };

  // üì∏ Upload post
  const uploadPost = async () => {
    if (!image) return alert("Select an image!");
    const storageRef = ref(storage, `images/${image.name}`);
    await uploadBytes(storageRef, image);
    const url = await getDownloadURL(storageRef);
    await addDoc(collection(db, "posts"), {
      user: user?.email,
      caption,
      imageUrl: url,
      likes: [],
      comments: [],
      createdAt: new Date(),
    });
    setCaption("");
    setImage(null);
  };

  // ‚ù§Ô∏è Like post
  const likePost = async (id) => {
    const refDoc = doc(db, "posts", id);
    await updateDoc(refDoc, {
      likes: arrayUnion(user.email),
    });
  };

  // üí¨ Add comment
  const addComment = async (id) => {
    const refDoc = doc(db, "posts", id);
    await updateDoc(refDoc, {
      comments: arrayUnion({ user: user.email, text: comment }),
    });
    setComment("");
  };

  return (
    <div style={{ fontFamily: "sans-serif", maxWidth: 500, margin: "auto" }}>
      <h1>üî• TopScrolling</h1>

      {!user ? (
        <div>
          <input
            placeholder="Email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
          />
          <input
            placeholder="Password"
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
          />
          <button onClick={signup}>Sign Up</button>
          <button onClick={login}>Login</button>
        </div>
      ) : (
        <div>
          <p>Welcome, {user.email}</p>
          <button onClick={logout}>Logout</button>
          <hr />

          <h3>Upload Post</h3>
          <input
            type="file"
            onChange={(e) => setImage(e.target.files[0])}
          />
          <input
            placeholder="Write caption..."
            value={caption}
            onChange={(e) => setCaption(e.target.value)}
          />
          <button onClick={uploadPost}>Post</button>

          <hr />
          <h3>üì∑ Posts</h3>
          {posts.map((p) => (
            <div
              key={p.id}
              style={{
                border: "1px solid #ddd",
                borderRadius: 10,
                marginBottom: 10,
                padding: 10,
              }}
            >
              <p><b>{p.user}</b></p>
              <img
                src={p.imageUrl}
                alt=""
                style={{ width: "100%", borderRadius: 10 }}
              />
              <p>{p.caption}</p>
              <button onClick={() => likePost(p.id)}>‚ù§Ô∏è Like ({p.likes.length})</button>
              <div>
                <input
                  placeholder="Write comment..."
                  value={comment}
                  onChange={(e) => setComment(e.target.value)}
                />
                <button onClick={() => addComment(p.id)}>üí¨</button>
              </div>
              <ul>
                {p.comments.map((c, i) => (
                  <li key={i}>
                    <b>{c.user}: </b> {c.text}
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
